{
  "variables": {
    "aws_access_key_id": "",
    "aws_secret_access_key": ""
  },
  "builders": [{    
    "type": "amazon-ebs",
    "communicator": "winrm",
    "source_ami": "ami-e659c7f0",
    "ami_name": "windows_build_pr",
    "region": "us-east-1",
    "instance_type": "c4.4xlarge",
    "winrm_username": "Administrator",
    "winrm_timeout": "6h",
    "subnet_id": "subnet-361ff61d",
    "security_group_id": "sg-85b3e7f8",
    "user_data_file": "./ec2-userdata.ps1",
    "ssh_private_ip": true,
    "associate_public_ip_address": false
  }],
  "provisioners": [
  {
    "type": "powershell",
    "scripts": [
        "Ec2Config.ps1",
        "ConfigureRemotingForAnsible.ps1"
    ]
  },
  {
    "type": "powershell",
    "inline": ["New-Item -ItemType Directory -Force -Path C:\\jenkins\\"]
  },
  {
    "type": "file",
    "source": "downloadr.exe",
    "destination": "c:\\jenkins\\downloadr.exe"
  },
  {
    "type": "file",
    "source": "config.json",
    "destination": "C:\\jenkins\\config.json"
  },
  {
    "type": "windows-shell",
    "inline": ["C:\\jenkins\\downloadr.exe -configFile C:\\jenkins\\config.json"],
    "environment_vars": [
        "AWS_SECRET_ACCESS_KEY={{user `aws_secret_access_key`}}",
        "AWS_ACCESS_KEY_ID={{user `aws_access_key_id`}}"
    ]
  },
  {
    "type" : "windows-shell",
    "inline" : ["net stop WSearch", "REG add \"HKLM\\SYSTEM\\CurrentControlSet\\Services\\WSearch\" /v Start /t REG_DWORD /d 4 /f" ]
  },
  {
    "type" : "windows-shell",
    "inline" : ["REG ADD \"HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\" /v AutoDetect /t REG_DWORD /d 0 /f"]
  },
  {
    "type": "powershell",
    "execute_command": "powershell -ExecutionPolicy Bypass \"& { {{.Vars}}{{.Path}}; exit $LastExitCode}\"",
    "scripts": [
      "enable-rdp.ps1",
      "disable-hibernate.ps1",
      "disable-autologin.ps1",
      "enable-uac.ps1",
      "no-expiration.ps1",
      "turn-off-windows-updates.ps1",
      "openssh.ps1",
      "windows-defender-exclusion.ps1",
      "disable-geolocation.ps1",
      "turn-off-windows-screensaver.ps1"
    ]
  },
  {
    "type" : "windows-shell",
    "inline" : ["c:\\windows\\system32\\powercfg.exe -change -monitor-timeout-ac 0", "c:\\windows\\system32\\powercfg.exe -change -monitor-timeout-dc 0", "c:\\windows\\system32\\powercfg.exe -change -disk-timeout-ac 0","c:\\windows\\system32\\powercfg.exe -change -disk-timeout-dc 0","c:\\windows\\system32\\powercfg.exe -change -standby-timeout-ac 0","c:\\windows\\system32\\powercfg.exe -change -standby-timeout-dc 0","c:\\windows\\system32\\powercfg.exe -change -hibernate-timeout-ac 0","c:\\windows\\system32\\powercfg.exe -change -hibernate-timeout-dc 0"]
  },
  {
    "type": "windows-restart",
    "restart_command": "powershell \"& {(Get-WmiObject win32_operatingsystem).LastBootUpTime > C:\\ProgramData\\lastboot.txt; Restart-Computer -force}\"",
    "restart_check_command": "powershell -command \"& {if ((get-content C:\\ProgramData\\lastboot.txt) -eq (Get-WmiObject win32_operatingsystem).LastBootUpTime) {Write-Output 'Sleeping for 600 seconds to wait for reboot'; start-sleep 600} else {Write-Output 'Reboot complete'}}\""
  },
  {
    "type" : "windows-shell",
    "inline" : ["c:\\jenkins\\tools\\Git-2.10.0-32-bit.exe /VERYSILENT", "c:\\jenkins\\tools\\DXSDK_Jun10.exe /U", "C:\\jenkins\\tools\\go1.6.3.windows-amd64.msi /quiet /norestart", "c:\\jenkins\\tools\\jre-8u101-windows-x64.exe /s"]
  },
  {
    "type" : "windows-shell",
    "inline" : ["net stop WSearch", "REG add \"HKLM\\SYSTEM\\CurrentControlSet\\Services\\WSearch\" /v Start /t REG_DWORD /d 4 /f" ]
  },
  {
    "type" : "windows-shell",
    "inline" : ["REG ADD \"HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\" /v AutoDetect /t REG_DWORD /d 0 /f"]
  },
  {
    "type" : "powershell",
    "execute_command": "powershell -ExecutionPolicy Bypass \"& { {{.Vars}}{{.Path}}; exit $LastExitCode}\"",
    "scripts" : [
      "./extract-zip.ps1",
      "./install-vs.ps1",
      "./set-git-config.ps1",
      "./create-dirs.ps1"
    ]
  },
  {
     "type" : "windows-shell",
     "inline": "cd c:\\jenkins\\tools\\mozilla-build\\python & python -m pip install compare-locales"
  }
]  
}

