{
  "variables": {
    "iso_path": "{{user `iso_path`}}",
    "iso_sha256": "{{user `iso_sha256`}}",
    "version" : "{{env `BUILD_NUMBER`}}"
  },

  "builders": [
  {    
    "type": "virtualbox-iso",
    "vboxmanage": [
        [ "modifyvm", "{{.Name}}", "--memory", "2048" ],
        [ "modifyvm", "{{.Name}}", "--vram", "48" ],
        [ "modifyvm", "{{.Name}}", "--cpus", "2" ]
    ],
    "communicator": "winrm",
    "disk_size": 102400,
    "floppy_files": [
      "fixnetwork.ps1",
      "Autounattend.xml",
      "configure-winrm.ps1"
    ],
    "guest_os_type": "Windows10_64",
    "headless": true,
    "iso_url": "{{user `iso_path`}}",
    "iso_checksum_type": "sha256",
    "iso_checksum": "{{user `iso_sha256`}}",    
    "winrm_username": "vagrant",
    "winrm_password": "vagrant",
    "winrm_timeout": "12h",
    "winrm_port": "5985",
    "shutdown_command": "shutdown /s /t 10 /f /d p:4:1 /c \"Packer Shutdown\"",
    "format": "ova"
    }
  ],
  "provisioners": [
  {
    "type" : "windows-shell",
    "inline" : ["Dism /online /enable-feature /featurename:NetFX3 /All /Source:D:\\sources\\sxs /LimitAccess"]
  },
  {
    "type" : "windows-shell",
    "inline" : ["net stop WSearch", "REG add \"HKLM\\SYSTEM\\CurrentControlSet\\Services\\WSearch\" /v Start /t REG_DWORD /d 4 /f" ]
  },
  {
    "type" : "windows-shell",
    "inline" : ["REG ADD \"HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\" /v AutoDetect /t REG_DWORD /d 0 /f"]
  },
  {
    "type": "powershell",
    "execute_command": "powershell -ExecutionPolicy Bypass \"& { {{.Vars}}{{.Path}}; exit $LastExitCode}\"",
    "scripts": [
      "enable-rdp.ps1",
      "disable-hibernate.ps1",
      "disable-autologin.ps1",
      "download-setup.ps1",
      "enable-uac.ps1",
      "no-expiration.ps1",
      "turn-off-windows-updates.ps1",
      "openssh.ps1",
      "windows-defender-exclusion.ps1",
      "disable-geolocation.ps1",
      "turn-off-windows-screensaver.ps1"
  ]},
   {
    "type" : "windows-shell",
    "inline" : ["c:\\windows\\system32\\powercfg.exe -change -monitor-timeout-ac 0", "c:\\windows\\system32\\powercfg.exe -change -monitor-timeout-dc 0", "c:\\windows\\system32\\powercfg.exe -change -disk-timeout-ac 0","c:\\windows\\system32\\powercfg.exe -change -disk-timeout-dc 0","c:\\windows\\system32\\powercfg.exe -change -standby-timeout-ac 0","c:\\windows\\system32\\powercfg.exe -change -standby-timeout-dc 0","c:\\windows\\system32\\powercfg.exe -change -hibernate-timeout-ac 0","c:\\windows\\system32\\powercfg.exe -change -hibernate-timeout-dc 0"]
  },
  {
    "type" : "powershell",
    "execute_command": "powershell -ExecutionPolicy Bypass \"& { {{.Vars}}{{.Path}}; exit $LastExitCode}\"",
    "scripts" : [
      "extract-zip.ps1",
      "set-git-config.ps1",
      "create-dirs.ps1"
    ]
  },
  {
    "type": "windows-restart",
    "restart_command": "powershell \"& {(Get-WmiObject win32_operatingsystem).LastBootUpTime > C:\\ProgramData\\lastboot.txt; Restart-Computer -force}\"",
    "restart_check_command": "powershell -command \"& {if ((get-content C:\\ProgramData\\lastboot.txt) -eq (Get-WmiObject win32_operatingsystem).LastBootUpTime) {Write-Output 'Sleeping for 600 seconds to wait for reboot'; start-sleep 600} else {Write-Output 'Reboot complete'}}\""
  }

]

}

